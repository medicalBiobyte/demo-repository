IMG2TEXT_PROMPT = """
다음은 제품 광고에서 추출한 텍스트(raw_text)입니다.  
이 텍스트에서 다음 항목을 추출해 주세요:

1. 제품명  
- 가장 눈에 띄는 상품명 또는 브랜드 이름  
- 영어와 한글 모두 존재하면 병기 (예: 키즈픽션 / KIDSFICTION)

2. 효능에 대한 광고 주장  
- “성장에 도움”, “면역력 향상”, “집중력”, “100% 환불” 등의 표현  
- 광고 상 문구를 되도록 있는 그대로 정리  
- 여러 문장일 경우 줄바꿈하여 나열

주의사항:  
- 추정하거나 상상하지 말고, 보이는 텍스트 기반으로만 추출  
- 출력은 JSON 형식으로 반환

예시 출력:
{
  "제품명": "키즈픽션 / KIDSFICTION",
  "효능_주장": [
    "효과 없을 시 100% 환불 책임 보장",
    "SR103 효모추출물 100%",
    "발효녹용 단백질 함유",
    "면역력에 좋은 유산균 2천억 CFU"
  ]
}
"""

WEB2INGREDIENT_PROMPT = """
다음은 건강기능식품 또는 의약외품 제품에 대한 웹 검색 결과입니다.

이 텍스트에는 다음 항목들이 포함되어 있습니다:
- 각 문단: 제품 설명 또는 성분 관련 정보
- 각 문단 말미: 해당 정보의 출처 URL (예: "출처: https://example.com/xxx")

이 텍스트를 바탕으로 다음 항목들을 JSON 형식으로 추출해 주세요:

---

1. 🔍 **성분_추출_출처**:
    - 어떤 실제 URL에서 어떤 성분이 나왔는지 정리
    - 어떤 문서(URL)에서 해당 내용을 확인했는지
    - 형식: { "성분명": "아연", "효능": "면역력 강화", "출처": "https://~~~" }
    - `"성분_내용"`: 해당 페이지에 언급된 성분 나열
    - 여러 출처가 있을 수 있으므로 배열 형태로 작성
    - 주의: 출처(URL)는 반드시 효능이 언급된 문장과 연결된 실제 URL이어야 합니다.
    - 주의: 블로그, 쇼핑몰, 커뮤니티 기반 정보는 배제하고 신뢰 가능한 공식 기관, 의학적/학술적 출처의 문단에서만 성분의 효능을 추출해 주세요.

2. 🧪 **확정_성분**:
    - 위 출처들을 바탕으로 정리된 최종 성분 리스트
    - 중복 제거, 일반 용어(예: "영양소", "비타민")는 제외

3. 🧠 **성분_효능**:
    - 각 성분이 어떤 효능을 갖는다고 설명되었는지 정리
    - "성장 촉진", "면역력 강화" 등 실제 표현을 유지

4. 📝 **요약**:
    - 이 제품이 어떤 효능을 중심으로 광고되고 있는지 요약
    - 핵심 문장 1~2개 이내

---

📥 아래는 웹 검색 결과 텍스트입니다:

{web_text}

---

출력 형식 예시:
```json
{
  "성분_추출_출처": [
    {
      "url": "https://example.com/product/kidsfiction",
      "성분_내용": "SR103 효모추출물, 발효녹용 단백질, 유산균 CFU 200Bn"
    }
  ],
  "확정_성분": [
    "SR103 효모추출물",
    "발효녹용 단백질",
    "유산균"
  ],
  "성분_효능": [
    {
      "성분명": "SR103 효모추출물",
      "효능": "성장 호르몬 분비 촉진"
    },
    {
      "성분명": "유산균",
      "효능": "장 건강, 면역력 강화"
    }
  ],
  "요약": "성장 발달과 면역력 향상을 함께 강조하는 어린이 건강기능식품"
}
"""

QUERY2KEYWORD_PROMPT = """
다음은 건강기능식품·의약외품에 대한 사용자 질문입니다:

"{query}"

질문이 암시하는 **효능/기능 키워드**를 추출하세요.

규칙
- 질문 속 표현을 그대로 사용하되, **가능한 한 ‘단어 단위’(어근 기준)** 로 분리해 추출
  · 예) “구강 항균” → ["구강", "항균"]  
- 조사, 어미, “~에 도움이 되나요?” 등 부속어는 제외
- 질문에 존재하지 않는 단어·추측·동의어는 생성하지 말 것
- 1 ~ 3개 키워드로 압축
- 반드시 **JSON 배열** 형태로 출력

출력 예:  
["키워드1", "키워드2", "키워드3"]

예시
1) 질문: "이 약 먹으면 키 크는 데 도움이 되나요?"  
   → ["성장", "키"]

2) 질문: "이 제품은 감기 예방이나 면역력 강화에 좋을까요?"  
   → ["면역력"]

3) 질문: "두뇌 발달이나 집중력 향상에 좋다던데 사실인가요?"  
   → ["두뇌", "집중력"]

4) 질문: "입 안에 뭐 났는데 이거 먹으면 효과 있나요?"  
   → ["구강", "항균"]
"""


INTENT_REFINEMENT_PROMPT = """
당신은 사용자의 모호한 질문에서 핵심 의도를 정확히 추론하여, 시스템이 검색 및 평가를 수행할 수 있는 명확하고 실행 가능한 **단일 질문**으로 재구성하는 AI 에이전트입니다. 사용자와의 상호작용 없이, 제공된 정보를 바탕으로 최선의 추론을 해야 합니다.

사용자의 다음 질문과 제공된 제품 정보를 분석해 주십시오:
사용자 원본 질문: "{user_query}"
이미지에서 추출된 제품명: "{product_name}"
이미지에서 주장하는 효능 (광고 문구): {image_claims}

다음 사항들을 평가하여 JSON 형식으로 반환해 주십시오:
1.  `is_ambiguous`: 사용자 원본 질문이 시스템이 직접 처리하기에 충분히 명확하지 않으면 true, 그렇지 않으면 false.
    - 원본 질문이 "키 크는데 효과 있나요?"와 같이 특정 주제를 포함하더라도, 질문 자체가 막연하다면 모호한 것(true)으로 판단하고, 아래 `inferred_query`를 통해 명확한 내부 처리용 질문으로 재구성해야 합니다.
2.  `inferred_query`: **(가장 중요)** 사용자의 원본 질문, 제품명, 광고 문구상의 효능 주장을 종합적으로 고려하여, 사용자가 가장 궁금해할 것으로 판단되는 **단일의 명확하고 구체적인 질문**을 생성합니다. 이 질문은 시스템 내부에서 후속 검색 및 평가의 기준으로 직접 사용됩니다.
    - **생성 지침:**
        - 원본 질문에서 특정 효능(예: '키 성장', '면역력')이 언급되었으나 질문이 막연한 경우, 해당 효능에 대한 직접적인 효과 유무를 묻는 명확한 질문으로 재구성합니다. (예: "'{product_name}' 제품이 {{언급된_효능}}에 직접적인 효과가 있습니까?")  # ✅ 여기 수정
        - 원본 질문이 매우 광범위하거나 일반적인 경우(예: "이거 좋은 건가요?"), 제품명과 광고 효능을 바탕으로 가장 핵심적이거나 대표적인 효능에 대한 질문으로 구체화합니다. (예: 광고 효능에 '피로 개선', '면역 증진'이 있다면, 그중 가장 가능성 높은 단일 효능에 대한 질문, 예를 들어 "'{product_name}' 제품이 피로 개선에 효과가 있습니까?" 와 같이 생성합니다.)
    - **주의: 절대로 사용자에게 선택지를 제시하거나, "다른 효능도 궁금하신가요?", "어떤 점이 궁금하신가요?" 와 같이 추가 정보를 요청하거나 되묻는 형태의 문장을 생성해서는 안 됩니다. 오직 시스템이 사용할 단일의, 완결된 형태의 정제된 질문만 생성해야 합니다.**
3.  `confidence_level`: 생성된 `inferred_query`가 실제 사용자의 숨겨진 의도를 얼마나 정확히 반영한다고 생각하는지 신뢰도 수준 ("매우 높음", "높음", "중간", "낮음")을 제시합니다.
4.  `reasoning`: `inferred_query`를 그렇게 생성한 간략한 핵심 이유 또는 추론 과정을 설명합니다. (내부 검토 및 로깅용)
5.  `refined_keywords`: 생성된 `inferred_query`에서 추출된 핵심 키워드 리스트를 제공합니다.
    (필요하다면 여기 예시에도 {{언급된_효능}} 사용: 예: ["{product_name}", "{{언급된_효능}}", "직접적 도움", "효과"]) # ✅ 여기도 해당된다면 수정

---
JSON 출력 예시:

# 예시 1: 사용자가 특정 효능을 언급했지만 질문이 막연한 경우
# 사용자 원본 질문: "이거 먹으면 키 크는데 효과 있나요?"
# 제품명: "키즈플랜 비오클"
# 이미지 주장 효능: ["어린이 키성장", "영양공급"]
{{
  "is_ambiguous": true,
  "inferred_query": "'키즈플랜 비오클' 제품이 어린이 키 성장에 직접적인 효과가 있습니까?",
  "confidence_level": "매우 높음",
  "reasoning": "사용자가 '키 크는데'라는 명확한 주제를 언급했고, 제품 광고에도 '어린이 키성장'이 있으므로, 이에 대한 직접적인 효과 유무를 묻는 질문으로 구체화하는 것이 가장 적절하다고 판단됨.",
  "refined_keywords": ["키즈플랜 비오클", "어린이 키 성장", "직접적 효과", "유무"]
}}

# 예시 2: 사용자의 질문이 전반적으로 매우 모호한 경우
# 사용자 원본 질문: "이거 괜찮은 건가요?"
# 제품명: "데일리케어 종합비타민"
# 이미지 주장 효능: ["피로회복", "면역력 증진", "항산화"]
{{
  "is_ambiguous": true,
  "inferred_query": "'데일리케어 종합비타민' 제품이 피로회복에 효과가 있습니까?",
  "confidence_level": "높음",
  "reasoning": "사용자 질문이 매우 일반적이므로, 제품의 광고된 주요 효능 중 가장 대표적이거나 첫 번째로 언급된 '피로회복'에 대한 효과를 질문하는 것으로 구체화함.",
  "refined_keywords": ["데일리케어 종합비타민", "피로회복", "효과"]
}}

# 예시 3: 질문이 이미 비교적 명확하여 약간의 다듬기만 필요한 경우
# 사용자 원본 질문: "이거 우리 아이 집중력에 진짜 좋아요?"
# 제품명: "브레인업 영양제"
# 이미지 주장 효능: ["기억력 개선", "두뇌 건강"]
{{
  "is_ambiguous": false,
  "inferred_query": "'브레인업 영양제'가 아이 집중력 향상에 실제로 효과가 있습니까?",
  "confidence_level": "매우 높음",
  "reasoning": "사용자 질문이 제품과 특정 효능(아이 집중력)에 대해 비교적 명확하게 질문하고 있으므로, 이를 약간 다듬어 내부 처리용 질문으로 구성함.",
  "refined_keywords": ["브레인업 영양제", "아이 집중력", "실제 효과"]
}}
---
"""

DATA_VALIDATION_PROMPT = """
당신은 여러 출처에서 수집된 건강기능식품 또는 의약품 관련 정보의 일관성을 검증하는 AI 에이전트입니다.
다음은 하나의 제품에 대해 서로 다른 단계에서 수집된 정보입니다.

1.  **이미지 주장 (`image_claims`):**
    - 제품명: {product_name_from_image}
    - 광고 문구상 효능 주장: {image_claims_list}

2.  **웹/DB 기반 성분 효능 (`ingredient_efficacy_info`):**
    - 확정 성분: {ingredients_from_web_db}
    - 각 성분 및 매칭된 효능 (출처: 웹/DB):
      {matched_ingredients_eval}
    - (존재한다면) RAG 시스템 보완 효능 (출처: fnclty DB):
      {rag_based_eval}

3.  **사용자 질문 핵심 키워드 (`user_query_keywords`):** {user_query_keywords}

위 정보를 바탕으로 다음 항목들을 평가하고 JSON 형식으로 반환해 주십시오:
1.  `consistency_status`: 정보들 간의 전반적인 일관성 상태 ("일치함", "부분적 불일치", "주요 불일치", "정보 부족으로 판단 어려움").
2.  `validation_details`:
    - 각 `image_claims_list` 항목에 대해, `ingredient_efficacy_info` (웹/DB 또는 RAG)에서 해당 주장을 뒷받침하는 근거가 있는지, 또는 사용자의 질문 키워드와 관련이 있는지 평가합니다.
    - 각 항목은 다음을 포함해야 합니다: `claim` (이미지 주장), `evidence_found` (true/false), `supporting_source` (근거 출처, 예: "웹 검색된 A성분 효능", "RAG 검색된 B성분 효능", "사용자 질문 키워드와 일치"), `discrepancy_note` (불일치 시 설명).
    - 일치하는 근거가 없거나 상반되는 정보가 있다면 명시합니다.
3.  `overall_assessment`: 검증 결과에 대한 종합적인 요약 코멘트.

JSON 출력 예시:
{{ 
  "consistency_status": "부분적 불일치",
  "validation_details": [
    {{ 
      "claim": "키 성장 촉진",
      "evidence_found": true,
      "supporting_source": "웹 검색된 '황기추출물' 효능, 사용자 질문 키워드 '키'와 일치",
      "discrepancy_note": ""
    }}, 
    {{ 
      "claim": "면역력 강화",
      "evidence_found": true,
      "supporting_source": "RAG 검색된 '홍삼' 효능",
      "discrepancy_note": ""
    }}, 
    {{ 
      "claim": "두뇌 발달",
      "evidence_found": false,
      "supporting_source": "정보 없음",
      "discrepancy_note": "이미지에서는 '두뇌 발달'을 주장하나, 제공된 성분 정보 및 사용자 질문에서는 관련 근거를 찾을 수 없음."
    }}  
  ],
  "overall_assessment": "키 성장 및 면역력 주장은 일부 근거가 있으나, 두뇌 발달 주장은 확인된 근거가 부족합니다."
}} 
"""